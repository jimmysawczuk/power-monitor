<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Power monitor</title>

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
</head>
<body>
	<div class="container">
		<div class="row">
			<div class="col-lg-6">
				<div id="battery-remaining-chart"></div>
			</div>

			<div class="col-lg-6">
				<div id="load-chart"></div>
			</div>
		</div>

		<div class="row">
			<div class="col-lg-6">
				<div id="remaining-runtime-chart"></div>
			</div>
		</div>
	</div>

	<script type="text/javascript" src="http://underscorejs.org/underscore-min.js"></script>
	<script type="text/javascript" src="//code.jquery.com/jquery-2.1.3.min.js"></script>
	<script type="text/javascript" src="//code.highcharts.com/highcharts.js"></script>
	<script type="text/javascript" src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="http://momentjs.com/downloads/moment.min.js"></script>
	<script type="text/javascript">
		$(document).ready(function()
		{
			function updateGraphs()
			{
				$.get('/api/snapshots', function(snapshots)
				{
					drawBatteryRemainingChart(snapshots);
					drawLoadChart(snapshots);
					drawRemainingRuntimeChart(snapshots);

					window.setTimeout(updateGraphs, 60 * 1000);
				}, 'json');
			}

			updateGraphs();
		});

		function drawBatteryRemainingChart(snapshots)
		{
			var data = [];
			_.each(snapshots, function(snapshot)
			{
				data.push([moment(snapshot.timestamp), snapshot.batteryRemaining]);
			});

			$('#battery-remaining-chart').highcharts({
				title: {
					text: "Battery remaining",
				},

				xAxis: {
					labels: {
						formatter: function() {
							return data[this.value][0].fromNow();
						}
					}
				},

				yAxis: {
					tickInterval: 0.20,
					endOnTick: false,
					labels: {
						formatter: function() {
							return (100 * this.value) + "%";
						}
					},
					min: 0,
					max: 1.1
				},

				tooltip: {
					formatter: function() {
						return '<b>' + data[this.x][0].fromNow() + ':</b> ' + (100 * this.y) + '%';
					}
				},

				series: [{
					name: "Battery remaining",
					data: data
				}]
			});
		}

		function drawLoadChart(snapshots)
		{
			var data = [];
			_.each(snapshots, function(snapshot)
			{
				data.push([moment(snapshot.timestamp), snapshot.load]);
			});

			$('#load-chart').highcharts({
				title: {
					text: "Load",
				},

				xAxis: {
					labels: {
						formatter: function() {
							return data[this.value][0].fromNow();
						}
					}
				},

				yAxis: {
					endOnTick: true,
					labels: {
						formatter: function() {
							return this.value + " W";
						}
					},
					min: 0
					// max: 1 * snapshots[0].batteryCapacity
				},

				tooltip: {
					formatter: function() {
						return '<b>' + data[this.x][0].fromNow() + ':</b> ' + this.y + ' W';
					}
				},

				series: [{
					name: "Load",
					data: data
				}]
			});
		}

		function drawRemainingRuntimeChart(snapshots)
		{
			var data = [];
			_.each(snapshots, function(snapshot)
			{
				data.push([moment(snapshot.timestamp), snapshot.remainingRuntime]);
			});

			$('#remaining-runtime-chart').highcharts({
				title: {
					text: "Remaining runtime",
				},

				xAxis: {
					labels: {
						formatter: function() {
							return data[this.value][0].fromNow();
						}
					}
				},

				yAxis: {
					endOnTick: true,
					labels: {
						formatter: function() {
							return (this.value) + " min";
						}
					},
					min: 0
				},

				tooltip: {
					formatter: function() {
						return '<b>' + data[this.x][0].fromNow() + ':</b> ' + (this.y) + ' min.';
					}
				},

				series: [{
					name: "Remaining runtime",
					data: data
				}]
			});
		}
	</script>
</body>
</html>
