<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Power monitor</title>

	<link rel="stylesheet" href="/bower/bootstrap/dist/css/bootstrap.min.css">
	<link rel="stylesheet/less" href="/less/style.less" type="text/css" />
</head>
<body>
	<div class="container">
		<div class="page-header">
			<h1>UPS Monitor <small id="model"></small></h1>
		</div>

		<div class="row snapshots">
			<div class="col-sm-3 snapshot">
				<div id="battery-remaining"></div>
			</div>

			<div class="col-sm-3 snapshot">
				<div id="load"></div>
			</div>

			<div class="col-sm-3 snapshot">
				<div id="remaining-runtime"></div>
			</div>

			<div class="col-sm-3 snapshot">
				<div id="utility-voltage"></div>
			</div>
		</div>

		<div class="row">
			<div class="col-lg-6">
				<div id="battery-remaining-chart"></div>
			</div>

			<div class="col-lg-6">
				<div id="load-chart"></div>
			</div>
		</div>

		<div class="row">
			<div class="col-lg-6">
				<div id="remaining-runtime-chart"></div>
			</div>
		</div>
	</div>

	<script type="text/javascript" src="/bower/underscore/underscore-min.js"></script>
	<script type="text/javascript" src="/bower/jquery/dist/jquery.min.js"></script>
	<script type="text/javascript" src="/bower/highcharts/highcharts.js"></script>
	<script type="text/javascript" src="/bower/bootstrap/dist/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/bower/moment/moment.js"></script>
	<script type="text/javascript" src="/bower/less/dist/less.min.js"></script>
	<script type="text/javascript">
		var Interval = {{ .Interval }};

		$(document).ready(function()
		{
			window.setInterval(update, 30 * 1000);
			update();
		});

		function update()
		{
			$.get('/api/snapshots', function(snapshots)
			{
				if (snapshots === null)
				{
					return;
				}

				_.each(snapshots, function(snapshot, i)
				{
					snapshots[i].duration = +moment() - +moment(snapshot.timestamp);
				});

				updateModel(snapshots[0]);

				updateBatteryRemaining(snapshots[0]);
				updateLoad(snapshots[0]);
				updateRemainingRuntime(snapshots[0]);
				updateUtilityVoltage(snapshots[0]);

				drawBatteryRemainingChart(snapshots);
				drawLoadChart(snapshots);
				drawRemainingRuntimeChart(snapshots);
			}, 'json');
		}

		function humanizeDuration(d)
		{
			var s = moment.duration(-d).humanize(true);
			s = s[0].toUpperCase() + s.substr(1);
			return s;
		}

		function updateModel(snapshot)
		{
			$('#model').html("Model " + snapshot.modelName);
		}

		function updateBatteryRemaining(snapshot)
		{
			$('#battery-remaining').html('<h1>' + snapshot.batteryRemaining * 100 + ' %<small>Battery remaining</small></h1>');
		}

		function updateLoad(snapshot)
		{
			$('#load').html('<h1>' + snapshot.load + ' W<small>Load</small></h1>');
		}

		function updateRemainingRuntime(snapshot)
		{
			$('#remaining-runtime').html('<h1>' + snapshot.remainingRuntime + ' min.<small>Remaining runtime</small></h1>');
		}

		function updateUtilityVoltage(snapshot)
		{
			$('#utility-voltage').html('<h1>' + snapshot.utilityVoltage + ' V<small>Utility voltage</small></h1>');
		}

		function getDefaultChartOptions(data)
		{
			return {
				xAxis: {
					labels: {
						formatter: function() {
							return humanizeDuration(this.value);
						}
					}
				},

				legend: {
					enabled: false
				},

				plotOptions: {
					line: {
						marker: {
							enabled: false
						}
					}
				}
			};
		}

		function drawBatteryRemainingChart(snapshots)
		{
			var data = [];
			_.each(snapshots, function(snapshot)
			{
				data.push([snapshot.duration, snapshot.batteryRemaining]);
			});

			$('#battery-remaining-chart').highcharts($.extend(true, getDefaultChartOptions(data), {
				title: {
					text: "Battery remaining",
				},

				yAxis: {
					tickInterval: 0.20,
					endOnTick: false,
					labels: {
						formatter: function() {
							return (100 * this.value) + "%";
						}
					},
					min: 0,
					max: 1.1
				},

				tooltip: {
					formatter: function() {
						return '<b>' + humanizeDuration(this.x) + ':</b> ' + (100 * this.y) + '%';
					}
				},

				series: [{
					name: "Battery remaining",
					data: data
				}]
			}));
		}

		function drawLoadChart(snapshots)
		{
			var data = [];
			_.each(snapshots, function(snapshot)
			{
				data.push([snapshot.duration, snapshot.load]);
			});

			$('#load-chart').highcharts($.extend(true, getDefaultChartOptions(data), {
				title: {
					text: "Load",
				},

				yAxis: {
					endOnTick: true,
					labels: {
						formatter: function() {
							return this.value + " W";
						}
					},
					min: 0
					// max: 1 * snapshots[0].batteryCapacity
				},

				tooltip: {
					formatter: function() {
						return '<b>' + humanizeDuration(this.x) + ':</b> ' + this.y + ' W';
					}
				},

				series: [{
					name: "Load",
					data: data
				}]
			}));
		}

		function drawRemainingRuntimeChart(snapshots)
		{
			var data = [];
			_.each(snapshots, function(snapshot)
			{
				data.push([snapshot.duration, snapshot.remainingRuntime]);
			});

			$('#remaining-runtime-chart').highcharts($.extend(true, getDefaultChartOptions(data), {
				title: {
					text: "Remaining runtime",
				},

				yAxis: {
					endOnTick: true,
					labels: {
						formatter: function() {
							return (this.value) + " min";
						}
					},
					min: 0
				},

				tooltip: {
					formatter: function() {
						return '<b>' + humanizeDuration(this.x) + ':</b> ' + (this.y) + ' min.';
					}
				},

				series: [{
					name: "Remaining runtime",
					data: data
				}]
			}));
		}
	</script>
</body>
</html>
